<!DOCTYPE html>

<html>

<head>
<title>Where in the World Is...</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&libraries=places"></script>
<link rel="stylesheet" href="geolocation_map_style.css" />

<script>

	function initialize_variables()
	{
		myLat = 0;
		myLng = 0;
		me = new google.maps.LatLng(myLat, myLng);
		myOptions = {
			zoom: 13, 
			center: me,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		infowindow = new google.maps.InfoWindow();
		numStops = 21;
		station = new Object();
	}

	function init()
	{
		initialize_variables();
		initStations();
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		drawPolyline();
		requestCarmenWaldo();
		getMyLocation();
	}

	function initStations(){
		station[0] = {'name': 'Alewife', 'lat': 42.395428, 'lon': -71.142483};
		station[1] = {'name': 'Davis', 'lat': 42.39674, 'lon': -71.121815};
		station[2] = {'name': 'Porter', 'lat': 42.3884, 'lon': -71.119149};
		station[3] = {'name': 'Harvard', 'lat': 42.373362, 'lon': -71.118956};
		station[4] = {'name': 'Central','lat': 42.365486, 'lon': -71.103802};
		station[5] = {'name': 'Kendall', 'lat': 42.36249079, 'lon': -71.08617653};
		station[6] = {'name': 'Charles MGH', 'lat': 42.361166, 'lon': -71.070628};
		station[7] = {'name': 'Park St', 'lat': 42.35639457, 'lon': -71.0624242};
		station[8] = {'name': 'Downtown Crossing', 'lat': 42.355518, 'lon': -71.060225};
		station[9] = {'name': 'South Station', 'lat': 42.352271, 'lon': -71.055242};
		station[10] = {'name': 'Broadway', 'lat': 42.342622, 'lon': -71.056967};
		station[11] = {'name': 'Andrew', 'lat': 42.330154, 'lon': -71.057655};
		station[12] = {'name': 'JFK', 'lat': 42.320685, 'lon': -71.052391};
		station[13] = {'name': 'Savinhill', 'lat': 42.31129, 'lon': -71.053331};
		station[14] = {'name': 'Fields Corner', 'lat': 42.300093, 'lon': -71.061667};
		station[15] = {'name': 'Shawmut', 'lat': 42.29312583, 'lon': -71.06573796};
		station[16] = {'name': 'Ashmont', 'lat': 42.284652, 'lon': -71.064489};
		station[17] = {'name': 'Wollaston', 'lat': 42.2665139, 'lon': -71.0203369};
		station[18] = {'name': 'Quincy Center', 'lat': 42.251809, 'lon': -71.005409};
		station[19] = {'name': 'Quincy Adams', 'lat': 42.233391, 'lon': -71.007153};
		station[20] = {'name': 'Braintree', 'lat': 42.2078543, 'lon': -71.0011385};		
	}

	function getMyLocation()
	{
		if (navigator.geolocation) { 
			navigator.geolocation.getCurrentPosition(function(position) {
				myLat = position.coords.latitude;
				myLng = position.coords.longitude;
				nearestStop();
				renderMap();
			});
		}
		else {
			alert("Geolocation is not supported by your web browser. What a shame!");
		}
	}

	function nearestStop(){
		nearestStop = station[0].name;
		minDistance = calculateDistance(station[0].lat, myLat, station[0].lon, myLng);
		for(var i = 1; i < numStops; i++){
			distance = calculateDistance(station[i].lat, myLat, station[i].lon, myLng);
			if (distance < minDistance){
				nearestStop = station[i].name;
				minDistance = distance;
			}
		}
	}

	Number.prototype.toRad = function()
	{
		return this * Math.PI / 180;
	}	

	function calculateDistance(lat1, lat2, lon1, lon2)
	{
		
		var R = 3958.57440545;
		var dLat = (lat2-lat1).toRad();
		var dLon = (lon2-lon1).toRad();
		var lat1 = lat1.toRad();
		var lat2 = lat2.toRad();
		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        		Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c;
		return d;
	}

	function requestCarmenWaldo(){

		try {

			request = new XMLHttpRequest();

		}

		catch (ms1) {
			try {
				request = new ActiveXObject("Msxml2.XMLHTTP");
			}
			catch (ms2) {
				try {
					request = new ActiveXObject("Microsoft.XMLHTTP");
				}
				catch (ex) {
					request = null;
				}
			}
		}

		if (request == null) {
			alert("Error creating request object -- Ajax not supported?");
		}


		try {

			request.open("GET", "http://messagehub.herokuapp.com/a3.json", true);

			request.send(null);

			request.onreadystatechange = callbackCarmenWaldo;

		}

		catch (error) {

			alert("Whoops, exception caught!");

		}

	}

	function callbackCarmenWaldo(){

		try {

			if (request.readyState == 4){
				waldo = new Object();
				carmen = new Object();
				waldo.exist = 'false';
				carmen.exist = 'false';
				parsed = JSON.parse(request.responseText);
				for (var i = 0; i < parsed.length; i++){
					if (parsed[i].name == 'Waldo'){
						waldo.lat = parsed[i]['loc']['latitude'];
						waldo.lon = parsed[i]['loc']['longitude'];
						waldo.name = parsed[i]['loc']['note'];
						console.log(waldo);
						waldo.exist = 'true';
					}
					if (parsed[i].name == 'Carmen'){
						carmen.lat = parsed[i]['loc']['latitude'];
						carmen.lon = parsed[i]['loc']['longitude'];
						carmen.name = parsed[i]['loc']['note'];
						carmen.exist = 'true';
						console.log(carmen);
					}
				}
				if (waldo.exist == 'true'){
					createMarker(waldo);
				}
				if (carmen.exist == 'true'){
					createMarker(carmen);
				}
			}

		}

		catch (error) {

			alert("Whoops, exception caught!");

		}

	}
	
	function requestSchedule()
	{
		
	}

	function callbackSchedule()
	{
		
	}
				
	function renderMap()
	{
		var me = new google.maps.LatLng(myLat, myLng);
		map.panTo(me);
		var marker = new google.maps.Marker({
			position: me,
			title: 'You are here' + '<br>' + 'Closest Station: ' 
			      + nearestStop + '<br>' + 'Distance: ' + minDistance
			      + ' miles'
				
		});
		marker.setMap(map);

		infowindow.setContent(marker.title);
		infowindow.open(map, marker);
		
		pic = 'mbtaT.png'
		for (var i = 0; i < numStops; i++){
			createMarker(station[i], pic);
		}
	}


	function createMarker(place, picture)
	{			
		var loc = new google.maps.LatLng(place.lat, place.lon);
		var marker = new google.maps.Marker({
			position: loc,
			title: place.name,
			icon: picture
		});
		marker.setMap(map);

		google.maps.event.addListener(marker, 'click', function() {
			infowindow.close();
			infowindow.setContent(place.name + '<table id="schedule"><tr><th>Line</th><th>Trip #</th><th>Direction</th><th>Time Remaining</th></tr></table>');
			infowindow.open(map, this);
		});
      	}

	function drawPolyline()
	{
		stationCoordinates = new Array();
		for(var i = 0; i < numStops; i++){
			stationCoordinates[i] = new google.maps.LatLng(station[i].lat, station[i].lon);
		}
        	var redLine = new google.maps.Polyline({
          		path: stationCoordinates,
          		strokeColor: '#FF0000',
          		strokeOpacity: 1.0,
          		strokeWeight: 5
       		});
		redLine.setMap(map);
	}	
		
</script>
</head>

<body onload="init()">
<div id="map_canvas"></div>
</body>
</html>