<!DOCTYPE html>

<html>

<head>
<title>Geolocation Map Example</title>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true&libraries=places"></script>
<link rel="stylesheet" href="geolocation_map_style.css" />

<script>
	var myLat = 0;
	var myLng = 0;
	var request = new XMLHttpRequest();
	var me = new google.maps.LatLng(myLat, myLng);
	var myOptions = {
		zoom: 13, 
		center: me,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map;
	var marker;
	var infowindow = new google.maps.InfoWindow();
	var places;
	var nearestStop;
	var numberOfStops = 21;

	function init()
	{
		initStations();
		map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
		getMyLocation();
		nearestStop();
	}

	function initStations(){
		var location = new Object;
		location[0] = {'name': 'alewife', 'lat': 42.395428, 'lon': -71.142483};
		location[1] = {'name': 'davis', 'lat': 42.39674, 'lon': -71.121815};
		location[2] = {'name': 'porter', 'lat': 42.3884, 'lon': -71.119149};
		location[3] = {'name': 'harvard', 'lat': 42.373362, 'lon': -71.118956};
		location[4] = {'name': 'central','lat': 42.365486, 'lon': -71.103802};
		location[5] = {'name': 'kendall', 'lat': 42.36249079, 'lon': -71.08617653};
		location[6] = {'name': 'charlesmgh', 'lat': 42.361166, 'lon': -71.070628};
		location[7] = {'name': 'parkst', 'lat': 42.35639457, 'lon': -71.0624242};
		location[8] = {'name': 'downtowncrossing', 'lat': 42.355518, 'lon': -71.060225};
		location[9] = {'name': 'southstation', 'lat': 42.352271, 'lon': -71.055242};
		location[10] = {'name': 'broadway', 'lat': 42.342622, 'lon': -71.056967};
		location[11] = {'name': 'andrew', 'lat': 42.330154, 'lon': -71.057655};
		location[12] = {'name': 'jfk', 'lat': 42.320685, 'lon': -71.052391};
		location[13] = {'name': 'savinhill', 'lat': 42.31129, 'lon': -71.053331};
		location[14] = {'name': 'fieldscorner', 'lat': 42.300093, 'lon': -71.061667};
		location[15] = {'name': 'shawmut', 'lat': 42.29312583, 'lon': -71.06573796};
		location[16] = {'name': 'ashmont', 'lat': 42.284652, 'lon': -71.064489};
		location[17] = {'name': 'wollaston', 'lat': 42.2665139, 'lon': -71.0203369};
		location[18] = {'name': 'quincycenter', 'lat': 42.251809, 'lon': -71.005409};
		location[19] = {'name': 'quincyadams', 'lat': 42.233391, 'lon': -71.007153};
		location[20] = {'name': 'braintree', 'lat': 42.2078543, 'lon': -71.0011385};		
	}

	function getMyLocation()
	{
		if (navigator.geolocation) { 
			navigator.geolocation.getCurrentPosition(function(position) {
				myLat = position.coords.latitude;
				myLng = position.coords.longitude;
				renderMap();
			});
		}
		else {
			alert("Geolocation is not supported by your web browser. What a shame!");
		}
	}

	function nearestStop(){
		nearestStop = location[0];
		minDistance = calculateDistance(location[0].lat, location[0].lon, myLat, myLng);
		for(i = 1; i < numberOfStops; i++){
			distance = calculateDistance(location[i].lat, location[i].lon, myLat, myLng);
			if (distance < minDistance){
				nearestStop = location[i].name;
				minDistance = distance;
			}
		}
	}

	function calculateDistance(lat1, lat2, lon1, lon2)
	{
		var R = 6371; // km
		var dLat = (lat2-lat1).toRad();
		dLon = (lon2-lon1).toRad();
		var lat1 = lat1.toRad();
		var lat2 = lat2.toRad();
		var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
       		Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
		var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
		var d = R * c;
		return d;
	}
		
	function requestCarmenWaldo()
	{
		try {
			request.open("GET", "http://messagehub.herokuapp.com/a3.json", true);
			request.send(null);
			request.onreadystatechange = callback;
		}
		catch (error) {
			alert("Whoops, exception caught!");
		}
	}

	function renderMap()
	{
		me = new google.maps.LatLng(myLat, myLng);
		map.panTo(me);
		marker = new google.maps.Marker({
			position: me,
			title: "Here I Am!"
		});
		marker.setMap(map);


		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(marker.title);
			infowindow.open(map, marker);
		});

		var request = {
			location: me,
			radius: '500',
			types: ['food']
		};
		service = new google.maps.places.PlacesService(map);
		service.search(request, callback);
	}


	function callback(results, status)
	{
		if (status == google.maps.places.PlacesServiceStatus.OK) {
			alert("Got places back!");
			places = results;
			for (var i = 0; i < results.length; i++) {
				createMarker(results[i]);
			}
		}
	}

	function createMarker(place)
	{
		var placeLoc = place.geometry.location;
		var marker = new google.maps.Marker({
			map: map,
			position: place.geometry.location
		});

		google.maps.event.addListener(marker, 'click', function() {
			infowindow.close();
			infowindow.setContent(place.name);
			infowindow.open(map, this);
		});
      	}
</script>
</head>

<body onload="init()">
<div id="map_canvas"></div>
</body>
</html>